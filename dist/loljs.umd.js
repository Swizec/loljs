!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){var t=require("../parser"),e=function(t,n){this._scope=[],this._next=[],this._io={visible:function(t){if(!console||"function"!=typeof console.log)throw new Error("console.log() not available");console.log.apply(console,e.utils.argsArray(arguments))},prompt:function(t,e){if("function"!=typeof prompt)throw new Error("prompt() not available");e(prompt(t))}},this._isPaused=!1,this._done=t||function(){},this._paused=n||function(){},this._currentNode=null,this._errors=[]};e.prototype._waitFor=function(t,e,n){n=n||{setIt:!1,breakOnReturn:!1},this._next.push({nodes:t.slice(0),results:[],f:e,options:n,inProgress:!1})},e.prototype._current=function(t){var e=this,n=t.nodes.shift();if(!n)return t.inProgress?void 0:(t.f(t.results),void(e._currentNode=null));t.inProgress=!0,this._evaluate(n,function(n){t.options.setIt&&e._setSymbol("IT",n),t.results.push(n),!t.nodes.length||t.options.breakOnReturn&&void 0!==e._getSpecial("return")?(t.f(t.results),e._currentNode=null):e._current(t)})},e.prototype.next=function(){if(this.errors().length)this.pause();else{this._isPaused=!1;var t=this._next.pop();t&&this._current(t)}},e.prototype.resume=function(){this._isPaused=!1,this.tick.go()},e.prototype.pause=function(t){this._isPaused=!0,t||this._paused.call(this)},e.prototype._error=function(t){this._errors.push(t),this.tick.cancel(),this.pause()},e.prototype.errors=function(){return this._errors},e.prototype.pos=function(){var t=this._currentNode._location;return{line:t.first_line-1,col:t.first_column,lineEnd:t.last_line-1,colEnd:t.last_column}},e.prototype._push=function(t){if(!t.name)throw new Error("Scope must have name");t.symbols=t.symbols||{},t.listeners=t.listeners||[],t.symbols.IT=null,this._scope.push(t)},e.prototype._pop=function(t){var e=this._scope.pop();if(!e||e.name!==t){for(var n="Couldn't pop state "+t+".\nStack:\n";e;)n+=e.name+"\n",e=this._scope.pop();throw new Error(n)}},e.prototype.getSymbol=function(t){for(var e=this._scope,n=e.length-1;n>=0;n--)if(e[n].symbols.hasOwnProperty(t))return e[n].symbols[t];throw new Error("No such symbol: "+t)},e.prototype._setSymbol=function(t,e){for(var n=this._scope,o=n.length-1;o>=0;o--)if(n[o].symbols.hasOwnProperty(t))return void(n[o].symbols[t]=e);n[n.length-1].symbols[t]=e},e.prototype._findScope=function(t){var e=this._scope;if(!t)return e[e.length-1];for(var n="string"==typeof t,o=e.length-1;o>=0;o--){if(n&&e[o].name===t)return e[o];if(!n&&t.indexOf(e[o].name)>=0)return e[o]}return null},e.prototype._findScopeForSpecial=function(t){return"return"===t?this._findScope("function"):"switch-condition"===t?this._findScope("switch"):"broken"===t?this._findScope(["switch","loop"]):this._scope[this._scope.length-1]},e.prototype._setSpecial=function(t,e){var n=this._findScopeForSpecial(t);n&&(n[t]=e)},e.prototype._getSpecial=function(t){var e=this._findScopeForSpecial(t);if(e)return e[t]},e.prototype._listen=function(t,e){this._findScope().listeners.push({event:t,action:e})},e.prototype._emit=function(t){for(var e=!1,n=this._scope.length-1;n>=0&&!e;n--)for(var o=this._scope[n],i=0;i<o.listeners.length&&!e;i++){var r=o.listeners[i];r.event===t&&r.action()&&(e=!0)}return e},e.prototype._index=function(t,e){if(!t||void 0===t.length)throw new Error("Not indexable");for(var n=e;n<0;)n+=t.length;if("string"==typeof t)return t.charAt(n);if("[object Array]"===Object.prototype.toString.call(t)){if(n<t.length)return t[n];throw new Error("Index "+e+" out of range")}throw new Error("Not indexable")},e.prototype._setIndex=function(t,e,n){if(!t||void 0===t.length)throw new Error("Not indexable");if("[object Array]"===Object.prototype.toString.call(t)){for(;n>t.length-1;)t.push(null);return t[n]=e,e}throw new Error("Not indexable")},e.prototype._evaluateLiteral=function(t,e){var n=this;"[object Array]"===Object.prototype.toString.call(t.value)?this._waitFor(t.value,function(t){e(t)}):e("string"==typeof t.value?t.value.replace(/:\{([\w_]+)\}/g,function(t,e){var o=e,i=t;try{i=n.getSymbol(o)}catch(t){n._error("No such symbol: "+o)}return i}):t.value)},e.prototype._evaluateIndexer=function(t,e){var n=this;this._waitFor([t.lhs,t.rhs],function(t){var o=n._index(t[0],t[1]);e(o)})},e.prototype._evaluateFunctionCall=function(t,e){var n=this;this._waitFor(t.args.values,function(o){var i;try{if("function"!=typeof(i=n.getSymbol(t.name)))throw new Error(t.name+" is not a function")}catch(t){return void n._error(""+t)}n._callFunction(i,o,e)})},e.prototype._evaluateBody=function(t,e){this._waitFor(t.lines,function(t){var n=t[t.length-1];void 0===n&&(n=null),e(n)},{setIt:!0,breakOnReturn:!0})},e.prototype._evaluateIdentifier=function(t,e){var n;try{n=this.getSymbol(t.name)}catch(t){return void this._error(""+t)}"function"!=typeof n?e(n):this._callFunction(n,[],e)},e.prototype._evaluateAssignmentIndex=function(t,e,n){var o=this;this._waitFor([t.name.lhs,t.name.rhs,t.value],function(t){var e=t[2];o._setIndex(t[0],e,t[1]),n(e)})},e.prototype._evaluateAssignmentNormal=function(t,e,n){this._setSymbol(t.name,e),n(e)},e.prototype._evaluateAssignment=function(t,e){var n=this;this._waitFor([t.value],function(o){var i=o[0];"Indexer"===t.name._name?n._evaluateAssignmentIndex(t,i,e):n._evaluateAssignmentNormal(t,i,e)})},e.prototype.evaluate=function(t,e){var n=this;this._waitFor([t.value],function(o){n._setSymbol(t.name,o[0]),e(o[0])})},e.prototype._evaluateDeclaration=function(t,e){var n=this;t.value?this._waitFor([t.value],function(o){n._setSymbol(t.name,o[0]),e(o[0])}):(n._setSymbol(t.name,null),e(null))},e.prototype._evaluateIf=function(t,e){var n=this,o=t.condition,i=t.elseIfs.slice(0),r=function(t){var e=i.shift();e?n._waitFor([e.condition],function(o){o[0]?n._waitFor([e.body],function(e){t(!0)}):r(t)}):t(!1)};!function(t){o?n._waitFor([o],t):t(n.getSymbol("IT"))}(function(o){o?function(e){n._waitFor([t.body],function(){e(null)})}(e):r(function(o){!o&&t.elseBody?n._waitFor([t.elseBody],e):e(null)})})},e.prototype._evaluateNoOp=function(t,e){e(null)},e.prototype._evaluateLoopCondition=function(t,e){t?this._waitFor([t.expression],function(n){e("while"===t.check?n[0]:!n[0])}):e(!0)},e.prototype._evaluateLoop=function(t,e){var n=this;if(t.op)try{this.getSymbol(t.op.symbol)}catch(e){this._setSymbol(t.op.symbol,0)}n._push({name:"loop"}),n._setSpecial("broken",!1);var o=function(){n._pop("loop"),e(null)},i=function(){n._waitFor([t.condition],function(e){var r,s=n._getSpecial("broken");null!==t.condition&&!e[0]||s?o():(r=function(){!function(){if(t.op){var e=n.getSymbol(t.op.symbol);e=t.op.command=e+1,n._setSymbol(t.op.symbol,e)}}(),i()},n._waitFor([t.body],r))})};this._listen("break",function(){return o(),!0}),i()},e.prototype._callFunction=function(t,e,n){var o=this;if(this._push({name:"function",symbol:t}),!t._data||t._data.builtIn){var i=t.apply(o,e);return this._pop("function"),void n(i)}for(var r=0;r<t._data.args.length;r++)this._setSymbol(t._data.args[r],void 0===e[r]?null:e[r]);t.call(o,function(t){o._pop("function"),n(t)})},e.prototype._evaluateFunctionDefinition=function(t,e){var n=function(e){var n=this;this._waitFor([t.body],function(t){var o=n._getSpecial("return");void 0===o&&(o=n.getSymbol("IT")),void 0===o&&(o=null),e(o)})};n._data={builtIn:!1,args:t.args.slice(0),name:t.name},this._setSymbol(t.name,n,{setIt:!0}),e(null)},e.prototype._evaluateCast=function(t,n){this._waitFor([t.expression],function(o){var i=o[0],r=t.type.toUpperCase();if("TROOF"===r)i=!!i;else if("NOOB"===r)i=null;else if("YARN"===r)i=e.utils.toYarn(i);else{if("NUMBR"!==r&&"NUMBAR"!==r)throw new Error("Unrecognised type: "+r);i=Number(i)}n(i)})},e.prototype._evaluateVisible=function(t,n){var o=this;this._waitFor([t.expression],function(t){o._io.visible(e.utils.toYarn(t[0])),n(t[0])})},e.prototype._evaluateGimmeh=function(t,e){var n=this;this._io.prompt("",function(o){n._setSymbol(t.variable,o),e(o)})},e.prototype._evaluateReturn=function(t,e){var n=this;this._waitFor([t.expression],function(t){n._setSpecial("return",t[0]),e(t[0])})},e.prototype._evaluateSwitch=function(t,n){var o=this,i=o.getSymbol("IT");this._push({name:"switch","switch-condition":i,broken:!1});var r=t.branches.slice(0);r.reverse();var s=!1;function a(){o._pop("switch"),n()}function u(){var t=r.pop();t&&!o._getSpecial("broken")?"CaseDefault"===t._name||s?l(t):o._waitFor([t.condition],function(n){e.builtIns["BOTH SAEM"](n[0],i)?l(t):u()}):a()}function l(t){o._waitFor([t.body],function(t){s=!o._getSpecial("broken"),u()})}this._listen("break",function(){return a(),!0}),u()},e.prototype._evaluateBreak=function(t,e){this._setSpecial("broken",!0),this._emit("break")||e()},e.prototype._evaluateBreakpoint=function(t,e){this.pause(),e()},e.prototype._evaluate=function(t,e){this._currentNode=t;var n={Assignment:this._evaluateAssignment,Break:this._evaluateBreak,Breakpoint:this._evaluateBreakpoint,Body:this._evaluateBody,Cast:this._evaluateCast,Declaration:this._evaluateDeclaration,FunctionCall:this._evaluateFunctionCall,FunctionDefinition:this._evaluateFunctionDefinition,Gimmeh:this._evaluateGimmeh,Identifier:this._evaluateIdentifier,If:this._evaluateIf,Indexer:this._evaluateIndexer,Literal:this._evaluateLiteral,Loop:this._evaluateLoop,LoopCondition:this._evaluateLoopCondition,NoOp:this._evaluateNoOp,Return:this._evaluateReturn,Switch:this._evaluateSwitch,Visible:this._evaluateVisible}[t._name];if(!n)throw new Error("Not implemented: "+t._name);n.call(this,t,e)},e.prototype._pushProgramState=function(){var t={};for(var n in e.builtIns)e.builtIns.hasOwnProperty(n)&&(t[n]=e.builtIns[n]);this._push({name:"program",symbols:t})},e.prototype._reset=function(){this._scope.length=0,this._next.length=0,this._pushProgramState(),this._errors.length=0,this._isPaused=!1,this._currentNode=null},e.prototype.evaluateWatchExpression=function(t,n,o){var i=new e(n,o);i._io=this._io,i._scope=this._scope.map(function(t){return function(t){var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}(t)}),i._scope.length||i._pushProgramState(),i.evaluate(t,!0)},e.prototype.evaluate=function(t,n){var o=this;n||this._reset();var i=!1;this._evaluate(t,function(t){i=!0,o._done.call(o,t)}),this.tick&&this.tick.cancel(),this.tick={_cancel:!1,_isRunning:!1,cancel:function(){this._cancel=!0},_go:function(){var t=this;if(this._cancel||o._isPaused)this._isRunning=!1;else{this._isRunning=!0;for(var n=+new Date;!i&&+new Date-n<200&&!o._isPaused;)o.next();i?this._isRunning=!1:e.utils.nextTick(function(){t._go()})}},go:function(){this._isRunning||this._go()}},this.tick.go()},e.prototype.setIo=function(t){"function"==typeof t.visible&&(this._io.visible=t.visible),"function"==typeof t.prompt&&(this._io.prompt=t.prompt)},e.utils={toYarn:function(t){if(!0===t)return"WIN";if(!1===t)return"FAIL";if(null===t)return"NOOB";if("[object Array]"===Object.prototype.toString.call(t)){for(var n="[",o=0;o<t.length;o++)n+=e.utils.toYarn(t[o]),o!==t.length-1&&(n+=", ");return n+"]"}return""+t}},e.utils.argsArray=function(t){return Array.prototype.slice.call(t)},e.builtIns={NOT:function(t){return!t},"ANY OF":function(t){for(var n=e.utils.argsArray(arguments),o=0;o<n.length;o++)if(n[o])return!0;return!1},"BIGGR OF":function(t,e){return Math.max(t,e)},"SMALLR OF":function(t,e){return Math.min(t,e)},"SUM OF":function(t,e){return t+e},"DIFF OF":function(t,e){return t-e},"PRODUKT OF":function(t,e){return t*e},"QUOSHUNT OF":function(t,e){return t/e},"BOTH OF":function(t,e){return t&&e},"EITHER OF":function(t,e){return t||e},"BOTH SAEM":function(t,e){return t===e},SMOOSH:function(t){var n=e.utils.argsArray(arguments);return e.utils.toYarn(n.reduce(function(t,n){return e.utils.toYarn(t)+e.utils.toYarn(n)}))},"BIGGR THAN":function(t,e){return t>e},"SMALLR THAN":function(t,e){return t<e},"MOD OF":function(t,e){return t%e},"LEN OF":function(t){return t&&void 0!==t.length?t.length:null},"ORD OF":function(t){return t&&t.charCodeAt?t.charCodeAt(0):-1},"CHR OF":function(t){return String.fromCharCode(t)}},module.exports={lol:e,parser:t}});
//# sourceMappingURL=loljs.umd.js.map
